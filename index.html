<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>بحث في ملف Excel</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; direction: rtl; }
    #searchBar { width: 50%; padding: 10px; font-size: 16px; margin-top: 20px; display:none; }
    #searchBtn, #clearBtn {
      padding: 10px 15px; margin: 5px;
      border: none; border-radius: 5px; background: #007bff; color: white; cursor: pointer;
    }
    #results, #selectedResults { width: 45%; border-collapse: collapse; margin: 20px; display:inline-table; vertical-align: top; }
    #results th, #results td, #selectedResults th, #selectedResults td {
      border: 1px solid #ccc; padding: 8px; text-align: center;
    }
    #results th, #selectedResults th { background-color: #f2f2f2; }
    #status { position: fixed; top: 10px; right: 10px; padding: 6px 12px; border-radius: 5px; color: white; font-weight: bold; }
    #status.active { background: green; }
    #status.inactive { background: red; }
    #cameraBtn {
      margin-top: 10px; padding: 10px 15px;
      border: none; border-radius: 5px; background: #28a745; color: white; cursor: pointer;
    }
    #reader { width: 300px; margin: 10px auto; display:none; }
    #passwordBox { margin-top:20px; }
    .num-keyboard { display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; width:150px; margin:15px auto; }
    .num-keyboard button {
      padding:15px; font-size:18px; border:none; background:#ddd; border-radius:5px; cursor:pointer;
    }
    #clearAllBtn {
      background: red; color: white; border: none; padding: 8px 12px; margin: 10px; cursor: pointer; border-radius: 5px;
    }
  </style>
</head>
<body>
  <h2>بحث في ملف Excel</h2>

  <!-- مؤشر حالة الملف -->
  <div id="status" class="inactive">لا يوجد ملف فعال</div>

  <!-- إدخال الباسورد -->
  <div id="passwordBox">
    <input type="password" id="passwordInput" placeholder="ادخل كلمة المرور">
    <button onclick="checkPassword()">دخول</button>
    <div class="num-keyboard">
      <button onclick="addDigit('1')">1</button>
      <button onclick="addDigit('2')">2</button>
      <button onclick="addDigit('3')">3</button>
      <button onclick="addDigit('4')">4</button>
      <button onclick="addDigit('5')">5</button>
      <button onclick="addDigit('6')">6</button>
      <button onclick="addDigit('7')">7</button>
      <button onclick="addDigit('8')">8</button>
      <button onclick="addDigit('9')">9</button>
      <button onclick="clearDigit()">⌫</button>
      <button onclick="addDigit('0')">0</button>
      <button onclick="checkPassword()">⏎</button>
    </div>
  </div>

  <!-- مربع البحث -->
  <div id="searchBox" style="display:none;">
    <input type="text" id="searchBar" placeholder="اكتب الاسم أو الباركود أو الوصف">
    <button id="searchBtn" onclick="search()">بحث</button>
    <button id="clearBtn" onclick="document.getElementById('searchBar').value=''">حذف</button>
  </div>

  <!-- زر الكاميرا -->
  <div>
    <button id="cameraBtn" onclick="toggleCamera()">تشغيل/إيقاف الكاميرا</button>
    <div id="reader"></div>
  </div>

  <!-- الجداول -->
  <div style="display:flex; justify-content:space-between;">
    <table id="results"></table>
    <table id="selectedResults"></table>
  </div>
  <button id="clearAllBtn" onclick="clearAllSelected()" style="display:none;">حذف الكل</button>

  <script>
    let excelData = [];
    let qrScanner = null;
    let scanning = false;

    const statusEl = document.getElementById('status');
    const searchBar = document.getElementById('searchBar');
    const resultsTable = document.getElementById('results');
    const selectedTable = document.getElementById('selectedResults');
    const clearAllBtn = document.getElementById('clearAllBtn');

    const headers = ["اسم المنتج", "سعر المنتج", "كود الميزان", "QR Code"];

    // تحميل ملف Excel
    fetch("product.template(176).xlsx")
      .then(res => res.arrayBuffer())
      .then(data => {
        const workbook = XLSX.read(new Uint8Array(data), { type: 'array' });
        const firstSheet = workbook.SheetNames[0];
        excelData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet], { header: 1 });
        statusEl.textContent = "ملف فعال";
        statusEl.className = "active";
      })
      .catch(err => {
        statusEl.textContent = "لا يوجد ملف فعال";
        statusEl.className = "inactive";
      });

    // باسورد
    function addDigit(d) { document.getElementById('passwordInput').value += d; }
    function clearDigit() {
      let input = document.getElementById('passwordInput');
      input.value = input.value.slice(0, -1);
    }
    function checkPassword() {
      const pass = document.getElementById('passwordInput').value;
      if (pass === "1234") {
        document.getElementById('passwordBox').style.display = "none";
        document.getElementById('searchBox').style.display = "block";
      } else alert("كلمة المرور غير صحيحة");
    }

    // البحث
    searchBar.addEventListener('keypress', e => { if (e.key === 'Enter') search(); });
    document.addEventListener('keydown', e => {
      if (e.key === 'Delete') searchBar.value = "";
    });

    function search(isQR=false, qrValue="") {
      const query = isQR ? qrValue.trim().toLowerCase() : searchBar.value.trim().toLowerCase();
      if (!query || excelData.length === 0) return;

      resultsTable.innerHTML = "";
      let headerRow = "<tr>";
      headers.forEach(h => headerRow += `<th>${h}</th>`);
      headerRow += "<th>إضافة</th></tr>";
      resultsTable.innerHTML = headerRow;

      excelData.forEach((row, index) => {
        if (index === 0) return;
        let a = (row[0] || "").toString().toLowerCase();
        let b = (row[1] || "").toString();
        let c = (row[2] || "").toString().toLowerCase();
        let d = (row[3] || "").toString().toLowerCase();

        if (a.includes(query) || c.includes(query) || d.includes(query)) {
          let tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row[0]||''}</td>
            <td>${row[1]||''}</td>
            <td>${row[2]||''}</td>
            <td>${row[3]||''}</td>
            <td><button onclick='addToSelected(${JSON.stringify(row)})'>إضافة</button></td>
          `;
          resultsTable.appendChild(tr);

          // يضاف تلقائيًا إذا البحث كان بالكاميرا أو كان البحث متطابق مع عمود QR Code
          if (isQR || d.includes(query)) {
            addToSelected(row);
          }
        }
      });
    }

    // إضافة للجدول الشمال
    function addToSelected(row) {
      if (selectedTable.innerHTML === "") {
        let headerRow = "<tr>";
        headers.forEach(h => headerRow += `<th>${h}</th>`);
        headerRow += "<th>حذف</th></tr>";
        selectedTable.innerHTML = headerRow;
      }
      let tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row[0]||''}</td>
        <td>${row[1]||''}</td>
        <td>${row[2]||''}</td>
        <td>${row[3]||''}</td>
        <td><button onclick='this.parentElement.parentElement.remove(); checkClearAll();'>حذف</button></td>
      `;
      selectedTable.appendChild(tr);
      clearAllBtn.style.display = "inline-block";
    }

    function clearAllSelected() {
      selectedTable.innerHTML = "";
      clearAllBtn.style.display = "none";
    }

    function checkClearAll() {
      if (selectedTable.rows.length <= 1) clearAllSelected();
    }

    // الكاميرا
    function toggleCamera() {
      const reader = document.getElementById('reader');
      if (scanning) {
        qrScanner.stop();
        reader.style.display = "none";
        scanning = false;
      } else {
        reader.style.display = "block";
        qrScanner = new Html5Qrcode("reader");
        qrScanner.start(
          { facingMode: "environment" },
          { fps: 10, qrbox: 250 },
          qrCodeMessage => {
            search(true, qrCodeMessage);
            toggleCamera();
          }
        ).catch(err => { alert("خطأ بالكاميرا: " + err); });
        scanning = true;
      }
    }
  </script>
</body>
</html>
