<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>بحث في ملف Excel</title>

  <!-- المكتبات كما في كودك الأصلي -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>

  <style>
    /* حافظت على الأساسيات كما في كودك الأصلي */
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      direction: rtl;
      margin: 0;
      background: #fff;
      color: #222;
    }

    h2 { text-align: center; margin-bottom: 12px; }

    /* حالة الملف (ثابتة في الركن) */
    #status {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 6px 12px;
      border-radius: 5px;
      color: white;
      font-weight: bold;
      z-index: 100;
    }
    #status.active { background: green; }
    #status.inactive { background: red; }

    /* صفحة الدخول (كيبورد رقمي صغير) */
    #passwordBox {
      text-align: center;
      margin-top: 60px;
    }
    #passwordInput {
      width: 200px;
      font-size: 20px;
      padding: 8px;
      text-align: center;
    }
    .numpad {
      display: inline-grid;
      grid-template-columns: repeat(3, 60px);
      gap: 6px;
      margin-top: 12px;
    }
    .numpad button {
      padding: 10px;
      font-size: 18px;
      cursor: pointer;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #f8f8f8;
    }

    /* المحتوى الرئيسي مخفي قبل الدخول */
    #mainContent { display: none; }

    /* تخطيط عمودين (يمين = بحث، شمال = نتائج) */
    .layout {
      display: flex;
      gap: 20px;
      align-items: flex-start;
      justify-content: space-between;
    }
    .col {
      width: 48%;
    }

    /* --- حافظت على شكل جدول البحث الأصلي --- */
    /* جدول النتائج (الذي كان في كودك الأصلي: id="results") */
    #results {
      width: 80%;
      margin: 20px auto;
      border-collapse: collapse;
    }
    #results th, #results td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
      word-break: break-word;
    }
    #results th { background-color: #f2f2f2; }

    /* جدول النتائج النهائي (شمال) */
    #finalResults {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    #finalResults th, #finalResults td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
      word-break: break-word;
    }
    #finalResults th { background-color: #f2f2f2; }

    /* العناصر التفاعلية */
    #searchBar {
      width: calc(100% - 110px);
      padding: 10px;
      font-size: 16px;
      box-sizing: border-box;
      display: inline-block;
    }
    #clearBtn {
      padding: 10px 12px;
      margin-right: 6px;
      cursor: pointer;
    }
    #cameraBtn {
      margin-top: 12px;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      background: #007bff;
      color: white;
      cursor: pointer;
    }
    #cameraPreview {
      width: 100%;
      max-width: 320px;
      height: auto;
      border: 1px solid #ccc;
      margin-top: 10px;
      display: none;
    }

    .addBtn {
      background: #28a745;
      color: white;
      border: none;
      padding: 6px 8px;
      border-radius: 4px;
      cursor: pointer;
    }
    .delBtn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 6px 8px;
      border-radius: 4px;
      cursor: pointer;
    }

    /* responsive بسيط */
    @media (max-width: 800px) {
      .layout { flex-direction: column; }
      .col { width: 100%; }
      #results { width: 100%; }
    }
  </style>
</head>
<body>

  <h2>بحث في ملف Excel</h2>

  <!-- مؤشر حالة الملف -->
  <div id="status" class="inactive">لا يوجد ملف فعال</div>

  <!-- صفحة الباسورد مع كيبورد أرقام -->
  <div id="passwordBox">
    <input id="passwordInput" type="password" placeholder="أدخل كلمة المرور" readonly>
    <div class="numpad" aria-hidden="false">
      <button type="button" onclick="appendNum('1')">1</button>
      <button type="button" onclick="appendNum('2')">2</button>
      <button type="button" onclick="appendNum('3')">3</button>
      <button type="button" onclick="appendNum('4')">4</button>
      <button type="button" onclick="appendNum('5')">5</button>
      <button type="button" onclick="appendNum('6')">6</button>
      <button type="button" onclick="appendNum('7')">7</button>
      <button type="button" onclick="appendNum('8')">8</button>
      <button type="button" onclick="appendNum('9')">9</button>
      <button type="button" onclick="backspaceNum()">مسح</button>
      <button type="button" onclick="appendNum('0')">0</button>
      <button type="button" onclick="checkPassword()">دخول</button>
    </div>
  </div>

  <!-- المحتوى الرئيسي (يظهر بعد الباسورد) -->
  <div id="mainContent">
    <div class="layout">
      <!-- العمود اليمين: جدول البحث كما في كودك الأصلي -->
      <div class="col" id="searchColumn">
        <!-- البحث -->
        <div style="text-align: center;">
          <input id="searchBar" type="text" placeholder="اكتب الاسم أو الباركود أو الوصف واضغط إنتر">
          <button id="clearBtn" onclick="clearSearch()">حذف</button>
        </div>

        <!-- زر الكاميرا و معاينة -->
        <div style="text-align: center; margin-top: 8px;">
          <button id="cameraBtn" onclick="toggleCamera()">تشغيل/إيقاف الكاميرا</button>
          <video id="cameraPreview" autoplay></video>
          <canvas id="canvas" style="display:none;"></canvas>
        </div>

        <!-- جدول النتائج (احتفظت بشكله الأصلي بالـ id = results) -->
        <table id="results"></table>
      </div>

      <!-- العمود الشمال: جدول النتائج النهائية -->
      <div class="col" id="finalColumn">
        <h3 style="text-align: center;">النتائج</h3>
        <div style="text-align: center; margin-bottom: 8px;">
          <button onclick="clearFinal()" class="delBtn">مسح الكل</button>
        </div>
        <table id="finalResults">
          <thead>
            <tr>
              <th>اسم المنتج</th>
              <th>سعر المنتج</th>
              <th>كود الميزان</th>
              <th>QR Code</th>
              <th>حذف</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    /************** متغيرات مركزية **************/
    let excelData = [];
    let videoStream = null;
    let scanning = false;

    const statusEl = document.getElementById('status');
    const passwordInput = document.getElementById('passwordInput');
    const passwordBox = document.getElementById('passwordBox');
    const mainContent = document.getElementById('mainContent');

    const searchBar = document.getElementById('searchBar');
    const resultsTable = document.getElementById('results');
    const finalTbody = document.querySelector('#finalResults tbody');

    const headers = ["اسم المنتج", "سعر المنتج", "كود الميزان", "QR Code"];

    /************** تحميل ملف Excel كما في كودك الأصلي **************/
    fetch("product.template(176).xlsx")
      .then(res => res.arrayBuffer())
      .then(data => {
        try {
          const workbook = XLSX.read(new Uint8Array(data), { type: 'array' });
          const firstSheet = workbook.SheetNames[0];
          excelData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet], { header: 1 });
          statusEl.textContent = "ملف فعال";
          statusEl.className = "active";
        } catch (err) {
          console.error("خطأ في قراءة ملف الإكسل:", err);
          statusEl.textContent = "ملف غير صالح";
          statusEl.className = "inactive";
        }
      })
      .catch(err => {
        console.warn("تعذر تحميل ملف الإكسل:", err);
        statusEl.textContent = "لا يوجد ملف فعال";
        statusEl.className = "inactive";
      });

    /************** كيبورد الباسورد (أرقام) **************/
    function appendNum(n) {
      passwordInput.value = (passwordInput.value || "") + n;
    }
    function backspaceNum() {
      passwordInput.value = (passwordInput.value || "").slice(0, -1);
    }
    function checkPassword() {
      const pass = passwordInput.value;
      if (pass === "1234") { // كلمة المرور كما كانت عندك
        passwordBox.style.display = "none";
        mainContent.style.display = "block";
        // الآن يمكن استخدام الحقل والزرار
        searchBar.focus();
      } else {
        alert("كلمة المرور غير صحيحة");
      }
    }

    /************** وظائف البحث - نفس الفكرة الأصلية تماماً **************/
    // بحث عند Enter في الحقل
    searchBar.addEventListener('keypress', function(e){
      if (e.key === 'Enter') search(false);
    });

    function clearSearch() {
      searchBar.value = "";
      resultsTable.innerHTML = "";
    }

    // البحث - fromQR = true لو تم استدعاء العملية من مسح الكاميرا
    function search(fromQR = false) {
      const query = (searchBar.value || "").trim().toLowerCase();
      if (!query || excelData.length === 0) return;

      // إعادة بناء جدول النتائج بنفس شكل كودك الأصلي (headers ثم الصفوف)
      let headerRow = "<tr>";
      headers.forEach(h => headerRow += `<th>${h}</th>`);
      headerRow += "</tr>";
      resultsTable.innerHTML = headerRow;

      // تمر على كل صف في excelData (تجاهل أول صف لو كان رؤوس)
      excelData.forEach((row, index) => {
        if (index === 0) return; // كما في كودك الأصلي
        const a = (row[0] || "").toString().toLowerCase();
        const b = (row[1] || "").toString();
        const c = (row[2] || "").toString().toLowerCase();
        const d = (row[3] || "").toString().toLowerCase();

        if (a.includes(query) || c.includes(query) || d.includes(query)) {
          // ننشئ صف DOM حتى نقدر نربط زر "إضافة" بأمان دون حقن JSON في الـ HTML
          const tr = document.createElement('tr');

          const td0 = document.createElement('td'); td0.textContent = row[0] || ''; tr.appendChild(td0);
          const td1 = document.createElement('td'); td1.textContent = row[1] || ''; tr.appendChild(td1);
          const td2 = document.createElement('td'); td2.textContent = row[2] || ''; tr.appendChild(td2);
          const td3 = document.createElement('td'); td3.textContent = row[3] || ''; tr.appendChild(td3);

          // خلية الزر
          const tdBtn = document.createElement('td');
          if (!fromQR) {
            const addBtn = document.createElement('button');
            addBtn.className = 'addBtn';
            addBtn.textContent = 'إضافة';
            // ربط الحدث - نمرر مصفوفة الصف كما هي
            addBtn.addEventListener('click', function(){ addToFinal(row); });
            tdBtn.appendChild(addBtn);
          } else {
            // لو البحث من QR، ما نعرضش زر الإضافة (حسب طلبك كان يضاف تلقائياً)
            tdBtn.textContent = '';
          }
          tr.appendChild(tdBtn);

          resultsTable.appendChild(tr);

          // لو البحث من QR → أضف مباشرة للنتائج النهائية (مرة واحدة)
          if (fromQR) {
            addToFinal(row);
          }
        }
      });
    }

    /************** جدول النتائج النهائي (إضافة/حذف صف) **************/
    function addToFinal(row) {
      // تحقق بسيط لو المنتج موجود مسبقاً عن طريق QR code (عمود 3)
      const qrVal = (row[3] || '').toString();
      const already = Array.from(finalTbody.querySelectorAll('tr')).some(r => r.cells[3] && r.cells[3].textContent === qrVal);
      if (already && qrVal !== '') return; // لو موجود لا نضيفه تاني

      const tr = document.createElement('tr');
      const td0 = document.createElement('td'); td0.textContent = row[0] || ''; tr.appendChild(td0);
      const td1 = document.createElement('td'); td1.textContent = row[1] || ''; tr.appendChild(td1);
      const td2 = document.createElement('td'); td2.textContent = row[2] || ''; tr.appendChild(td2);
      const td3 = document.createElement('td'); td3.textContent = row[3] || ''; tr.appendChild(td3);

      const tdDel = document.createElement('td');
      const delBtn = document.createElement('button');
      delBtn.className = 'delBtn';
      delBtn.textContent = 'حذف';
      delBtn.addEventListener('click', function(){ this.closest('tr').remove(); });
      tdDel.appendChild(delBtn);
      tr.appendChild(tdDel);

      finalTbody.appendChild(tr);
    }

    function clearFinal() {
      finalTbody.innerHTML = '';
    }

    /************** كاميرا وقراءة QR كما في كودك الأصلي **************/
    function toggleCamera() {
      const video = document.getElementById('cameraPreview');
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');

      if (videoStream) {
        // إيقاف
        video.srcObject.getTracks().forEach(track => track.stop());
        videoStream = null;
        video.style.display = 'none';
        scanning = false;
      } else {
        // تشغيل
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
          .then(stream => {
            video.srcObject = stream;
            videoStream = stream;
            video.style.display = 'block';
            scanning = true;
            scanLoop();
          })
          .catch(err => {
            alert('لم يتم تشغيل الكاميرا: ' + err);
          });
      }

      function scanLoop() {
        if (!scanning) return;
        const video = document.getElementById('cameraPreview');
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, canvas.width, canvas.height);
          if (code) {
            // ضع الكود في خانة البحث واطلب البحث مع العلم أنه جاء من QR
            searchBar.value = code.data;
            search(true);
            scanning = false;
            // أغلق الكاميرا
            toggleCamera();
            return;
          }
        }
        requestAnimationFrame(scanLoop);
      }
    }
  </script>
</body>
</html>
